<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>LIFF自動發訊息</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>正在處理中...</h1>

  <script>
    async function main() {
        await liff.init({ liffId: "2007338941-D63gmVoP" });

        // ⭐ 如果還沒登入，就登入，並且強制要求 scope
        if (!liff.isLoggedIn()) {
            liff.login({
            scope: ['profile', 'chat_message.write'],   // 💬 特別注意：這裡一定要帶
            redirectUri: window.location.href           // ⭐ 讓它回來這一頁，繼續動作
            });
            return;  // login 之後頁面會重新整理，所以這裡 return
        }

        try {
            await liff.sendMessages([
            {
                type: "text",
                text: "👋 哈囉！這是自動發送的訊息！"
            }
            ]);
            alert("訊息已成功發送！");
            liff.closeWindow();  // 成功後關掉
        } catch (err) {
            console.error('發送失敗', err);

            if (err.message && err.message.includes('user doesn\'t grant required permissions')) {
            // 🛑 如果真的沒授權，要重新登入一次
            alert('您尚未授權發送訊息，請同意授權！');
            liff.logout();
            liff.login({
                scope: ['profile', 'chat_message.write'],
                redirectUri: window.location.href
            });
            } else {
            alert("發生其他錯誤，請重新嘗試！");
            }
        }
        }
  </script>
</body>
</html>
