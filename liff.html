<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE LIFF 自動發送訊息</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #message {
            margin: 20px 0;
            font-size: 18px;
        }
        .btn {
            background-color: #06C755;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="message">正在連接到LINE...</div>
    <button id="sendMessageBtn" class="btn" style="display: none;">手動發送訊息</button>

    <!-- 引入LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化LIFF
            // 請將YOUR_LIFF_ID替換為您的LIFF ID
            liff.init({
                liffId: "2007338941-D63gmVoP",
                withLoginOnExternalBrowser: true,
                scope: ["chat_message.write", "openid", "profile"]  // 允許在外部瀏覽器中登入
            }).then(() => {
                // 檢查登入狀態
                if (!liff.isLoggedIn()) {
                    liff.login({// 登入後重定向回當前頁面
                        scope: "chat_message.write,openid,profile"
                        });
                } else {
                    // 已登入後的操作
                    document.getElementById('message').textContent = '已連接到LINE，正在發送訊息...';
                    sendMessage();
                }
            }).catch(err => {
                console.error('LIFF初始化失敗', err);
            });

            // 發送訊息到聊天視窗
            function sendMessage() {
                // 檢查是否在LINE應用內
                if (liff.isInClient()) {
                    // 使用sendMessages在LINE應用內發送訊息
                    liff.sendMessages([{
                        type: 'text',
                        text: '您好！我掃描了QR Code並訪問了您的網頁。'
                    }])
                    .then(() => {
                        document.getElementById('message').textContent = '訊息已發送！';
                    })
                    .catch((error) => {
                        document.getElementById('message').textContent = '發送訊息時發生錯誤';
                        console.error('發送訊息錯誤', error);
                    });
                } else {
                    // 如果在外部瀏覽器，則使用shareTargetPicker
                    liff.shareTargetPicker([{
                        type: 'text',
                        text: '您好！我掃描了QR Code並訪問了您的網頁。'
                    }])
                    .then(result => {
                        if (result) {
                            document.getElementById('message').textContent = '訊息已發送！';
                        } else {
                            document.getElementById('message').textContent = '訊息發送取消';
                        }
                    })
                    .catch(error => {
                        document.getElementById('message').textContent = '發送訊息時發生錯誤';
                        console.error('發送訊息錯誤', error);
                    });
                }
            }
            // 手動發送按鈕點擊事件
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        });
    </script>
</body>
</html>